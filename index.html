<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The 613 Mitzvot | Interactive Sefer HaChinukh</title>
    <link rel="icon" type="image/svg+xml" href="images/favicon.svg" />

    <!-- Bootstrap CSS (from vendor) -->
    <link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.min.css" />

    <!-- Fonts (from vendor) -->
    <link rel="stylesheet" href="styles/fonts.css" />

    <!-- Tom Select CSS (from vendor) -->
    <link rel="stylesheet" href="vendor/tom-select/css/tom-select.bootstrap5.css" />

    <!-- Select2 CSS (from vendor) -->
    <link rel="stylesheet" href="vendor/select2/css/select2.min.css" />

    <!-- Custom styles -->
    <link rel="stylesheet" href="styles/app.css" />
  </head>
  <body>
    <!-- Beta Banner -->
    <div class="alert alert-light m-0 rounded-0 text-center py-2" role="alert" id="topBanner" style="border-left: none; border-right: none; border-top: none; font-size: 0.9rem; position: relative">
      <strong>‚ö†Ô∏è Beta:</strong> This project is still new and evolving. Please double-check with your own or official sources when using this information. Feedback welcome at
      <a href="mailto:moxaku@gmail.com" class="alert-link">moxaku@gmail.com</a>
      <button
        type="button"
        onclick="document.getElementById('topBanner').style.display='none'"
        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 1.2rem; line-height: 1; cursor: pointer; opacity: 0.5"
        onmouseover="this.style.opacity='1'"
        onmouseout="this.style.opacity='0.5'"
        aria-label="Close"
      >
        &times;
      </button>
    </div>
    <div class="container mt-2">
      <div class="header">
        <div class="header-top">
          <div class="header-date" id="hebrewDate">Loading...</div>
          <div class="header-hebrew-text">
            <div class="bsd">◊ë◊°◊¥◊ì</div>
            <div class="based-on">◊û◊ë◊ï◊°◊° ◊¢◊ú ◊°◊§◊® ◊î◊ó◊ô◊†◊ï◊ö</div>
          </div>
        </div>
        <div class="header-title-wrapper">
          <h1 class="app-title title-en">TARYAG ‚Äî The 613</h1>
          <!-- <h1 class="app-title title-en">TARYAG</h1> -->
          <!-- <h2 class="subtitle title-en">The 613 Mitzvot</h2> -->
          <!-- <h2 class="tagline subtitle title-en">Based on Sefer HaChinukh</h2> -->
          <p class="tagline subtitle title-en1">Learn and explore the 613 mitzvot ‚Äî based on the teachings of Sefer HaChinukh</p>
        </div>
        <div class="header-bottom">
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search mitzvot..." />
          </div>
          <div class="header-stats" id="headerStats">
            <!-- Stats cards will be displayed here -->
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="filter-controls">
          <div class="primary-filters">
            <span class="filter-label">Quick filters:</span>
            <div class="stats" id="stats">
              <!-- Stats will be loaded dynamically as clickable filters -->
            </div>
            <span class="separator d-none d-md-inline">|</span>
            <div class="scope-filters" id="scopeFilters">
              <!-- Scope icon filters will be rendered here -->
            </div>
            <button id="moreFiltersBtn" class="btn btn-sm btn-light" onclick="app.toggleMoreFilters()">
              <span id="moreFiltersText">More Filters</span>
              <span id="moreFiltersIcon">‚ñº</span>
            </button>
            <div class="language-controls" id="tableLanguageToggle" style="display: none">
              <button class="btn btn-sm btn-outline-dark table-lang-btn active" data-lang="en" onclick="app.setTableLanguage('en')">EN</button>
              <button class="btn btn-sm btn-outline-dark table-lang-btn" data-lang="he" onclick="app.setTableLanguage('he')">◊¢◊ë</button>
              <button class="btn btn-sm btn-outline-dark table-lang-btn" data-lang="both" onclick="app.setTableLanguage('both')">Both</button>
            </div>
          </div>
          <div class="secondary-filters" id="secondaryFilters" style="display: none">
            <div class="input-group input-group-sm">
              <span class="input-group-text"><i data-lucide="book-open" style="width: 16px; height: 16px"></i></span>
              <select id="bookFilter" class="form-select form-select-sm filter-select">
                <option value="">All Books</option>
              </select>
            </div>
            <div class="input-group input-group-sm">
              <span class="input-group-text"><i data-lucide="scroll-text" style="width: 16px; height: 16px"></i></span>
              <select id="parashaFilter" class="form-select form-select-sm filter-select">
                <option value="">All Parashot</option>
              </select>
            </div>
            <div class="input-group input-group-sm">
              <span class="input-group-text"><i data-lucide="folder" style="width: 16px; height: 16px"></i></span>
              <select id="categoryFilter" class="form-select form-select-sm filter-select">
                <option value="">All Categories</option>
              </select>
            </div>
            <div class="input-group input-group-sm">
              <span class="input-group-text"><i data-lucide="users" style="width: 16px; height: 16px"></i></span>
              <select id="appliesToFilter" class="form-select form-select-sm filter-select">
                <option value="">Applies To: All</option>
              </select>
            </div>
            <div class="input-group input-group-sm">
              <span class="input-group-text"><i data-lucide="map-pin" style="width: 16px; height: 16px"></i></span>
              <select id="locationFilter" class="form-select form-select-sm filter-select">
                <option value="">All Locations</option>
              </select>
            </div>
            <div class="input-group input-group-sm">
              <span class="input-group-text"><i data-lucide="clock" style="width: 16px; height: 16px"></i></span>
              <select id="timeScopeFilter" class="form-select form-select-sm filter-select">
                <option value="">All Time Scopes</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        Loading mitzvot data...
      </div>

      <div class="error" id="error" style="display: none">Error loading mitzvot data. Please check that mitzvot_data.json is available.</div>

      <div class="table-container" id="tableContainer" style="display: none">
        <table id="mitzvotTable">
          <thead>
            <tr>
              <th class="sortable" data-sort="id">
                <span class="sort-label">#</span>
                <span class="sort-indicator"></span>
              </th>
              <th class="sortable" data-sort="type">
                <span class="sort-label">Type</span>
                <span class="sort-indicator"></span>
              </th>
              <th>Mitzvah</th>
              <th>Scope</th>
              <th>Description</th>
              <th class="sortable" data-sort="parasha">
                <span class="sort-label">Parasha</span>
                <span class="sort-indicator"></span>
              </th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody id="mitzvotTableBody">
            <!-- Table rows will be loaded dynamically -->
          </tbody>
        </table>

        <!-- Mobile cards container -->
        <div class="mobile-cards" id="mobileCards">
          <!-- Cards will be loaded dynamically -->
        </div>
      </div>

      <div class="pagination" id="pagination" style="display: none">
        <!-- Pagination will be loaded dynamically -->
      </div>
    </div>

    <!-- Sidebar for details -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="app.closeSidebar()"></div>
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2 id="sidebarTitle">Mitzvah Details</h2>
        <div class="language-toggle">
          <button class="language-btn active" data-lang="en" onclick="app.setLanguage('en')">English</button>
          <button class="language-btn" data-lang="he" onclick="app.setLanguage('he')">◊¢◊ë◊®◊ô◊™</button>
          <button class="language-btn" data-lang="both" onclick="app.setLanguage('both')">Both</button>
        </div>
        <button class="sidebar-close" onclick="app.closeSidebar()">&times;</button>
      </div>
      <div class="sidebar-content" id="sidebarContent">
        <!-- Content will be loaded dynamically -->
      </div>
    </div>

    <!-- Card Modal -->
    <div class="card-modal-overlay" id="cardModalOverlay" onclick="app.closeCardModal()"></div>
    <div class="card-modal" id="cardModal">
      <button class="card-modal-close" onclick="app.closeCardModal()">&times;</button>
      <div class="mtg-card" id="mtgCard">
        <!-- Card content will be loaded dynamically -->
      </div>
    </div>

    <!-- jQuery (from vendor - required by Select2) -->
    <script src="vendor/jquery/jquery.min.js"></script>

    <!-- Bootstrap JS (from vendor - includes tooltip/popover functionality) -->
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Select2 library (from vendor) -->
    <script src="vendor/select2/js/select2.min.js"></script>

    <!-- Tom Select library (from vendor) -->
    <script src="vendor/tom-select/js/tom-select.complete.min.js"></script>

    <!-- Lucide icons (from vendor) -->
    <script src="vendor/lucide/lucide.min.js"></script>

    <!-- SweetAlert2 (from vendor) -->
    <script src="vendor/sweetalert2/sweetalert2.all.min.js"></script>

    <script>
      // Version: 2025-10-20-v1 - Add image extension fallback (.png -> .jpg -> .jpeg)

      // Global helper: on image load error, try next extension; finally show placeholder
      const IMAGE_EXT_FALLBACKS = ["png", "jpg", "jpeg"];
      function loadMitzvahImageFallback(imgEl, mitzvahId) {
        try {
          const currentIndex = parseInt(imgEl.dataset.extIndex || "0", 10);
          if (currentIndex < IMAGE_EXT_FALLBACKS.length - 1) {
            const nextIndex = currentIndex + 1;
            imgEl.dataset.extIndex = String(nextIndex);
            const nextExt = IMAGE_EXT_FALLBACKS[nextIndex];
            // Hide placeholder if previously shown while retrying
            const placeholder = imgEl.nextElementSibling;
            if (placeholder && placeholder.classList.contains("mtg-card-image-placeholder")) {
              placeholder.style.display = "none";
            }
            imgEl.style.display = ""; // ensure visible
            imgEl.src = `images/${mitzvahId}.${nextExt}`;
          } else {
            // Exhausted all fallbacks: hide image, show placeholder
            imgEl.style.display = "none";
            const placeholder = imgEl.nextElementSibling;
            if (placeholder && placeholder.classList.contains("mtg-card-image-placeholder")) {
              placeholder.style.display = "flex";
            }
          }
        } catch (e) {
          // As a last resort, hide image and show placeholder
          imgEl.style.display = "none";
          const placeholder = imgEl.nextElementSibling;
          if (placeholder && placeholder.classList.contains("mtg-card-image-placeholder")) {
            placeholder.style.display = "flex";
          }
        }
      }

      // Version note: previous version 2025-10-19-v2 updated truncation with smart quotes
      // Keeping class definition below unchanged except for image rendering
      // to use the new fallback handler.
      //
      // End of global helpers

      // Version: 2025-10-19-v2 - Updated truncation with smart quotes
      class MitzvotApp {
        constructor() {
          this.data = null;
          this.heData = null;
          this.filteredData = [];
          this.currentPage = 1;
          this.itemsPerPage = 50;
          this.sortField = "id";
          this.sortDirection = "asc";
          this.currentLanguage = "en";
          this.tableLanguage = "en"; // Language for table descriptions
          this.currentMitzvahId = null;
          this.moreFiltersVisible = false;
          this.typeFilter = ""; // "" = all, "Positive", "Negative"
          this.activeScopeKey = ""; // one of scope keys or ""

          // Feature flags
          // Disable MTG-style card previews for now
          this.cardsEnabled = false;

          // Tom Select instances map
          this.selects = {
            type: null,
            book: null,
            parasha: null,
            category: null,
            appliesTo: null,
            location: null,
            timeScope: null,
          };

          this.init();
        }

        async init() {
          try {
            await this.loadData();
            this.setupEventListeners();
            this.enhanceSelects();
            lucide.createIcons(); // Initialize filter icons
            this.render();
            // Update Hebrew date with mitzvot counts now that data is loaded
            loadHebrewDate(this);
          } catch (error) {
            console.error("Error initializing app:", error);
            this.showError();
          }
        }

        enhanceSelects() {
          // Helper to init Select2 with consistent settings
          const initSelect2 = (selector, key, options = {}) => {
            const el = $(selector);
            if (!el.length) return;
            try {
              // Destroy existing instance if any
              if (el.data("select2")) {
                el.select2("destroy");
              }

              // Default config
              const config = {
                placeholder: options.placeholder || "All",
                allowClear: true,
                width: "100%",
                minimumResultsForSearch: options.minimumResultsForSearch || 5,
                theme: "classic",
                ...options.config,
              };

              this.selects[key] = el.select2(config).data("select2");
            } catch (e) {
              console.warn("Select2 init failed for", selector, e);
            }
          };

          // Initialize all filters with Select2
          initSelect2("#typeFilter", "type", { placeholder: "All Types" });
          initSelect2("#bookFilter", "book", { placeholder: "All Books" });
          initSelect2("#parashaFilter", "parasha", { placeholder: "All Parashot" });
          initSelect2("#categoryFilter", "category", { placeholder: "All Categories" });
          initSelect2("#appliesToFilter", "appliesTo", { placeholder: "Applies To" });
          initSelect2("#locationFilter", "location", { placeholder: "All Locations" });
          initSelect2("#timeScopeFilter", "timeScope", { placeholder: "All Time Scopes" });
        }

        // Helper function to truncate text at sentence end
        truncateText(text, maxLength = 120) {
          if (!text || text.length <= maxLength) return text;

          // Find the nearest sentence ending after maxLength
          // Look for period, exclamation, or question mark, optionally followed by quotes/tags, then space or end
          // Includes both regular quotes and smart quotes (U+201C, U+201D, U+2018, U+2019)
          const sentenceEnders = /[.!?]["'¬ª\u201C\u201D\u2018\u2019]?[)\]>]?(?:\s|$)/g;
          let match;
          let lastSentenceEnd = -1;

          // Debug for first mitzvah only
          const isDebug = text.includes("Bereshit") && text.includes("procreation");
          if (isDebug) {
            console.log("Truncating:", text.substring(0, 50) + "...");
            console.log("Text length:", text.length, "maxLength:", maxLength);
          }

          // Find all sentence endings up to and slightly beyond maxLength
          while ((match = sentenceEnders.exec(text)) !== null) {
            // Get the position right after the sentence-ending punctuation (including any trailing quotes/brackets)
            const endPosition = match.index + match[0].trimEnd().length;

            if (isDebug) {
              console.log("Found match at", match.index, "ending at", endPosition, ":", match[0]);
            }

            // If we found a sentence ending before maxLength, keep track of it
            if (endPosition <= maxLength) {
              lastSentenceEnd = endPosition;
            }
            // If we found one after maxLength, use it and stop
            else if (endPosition > maxLength) {
              if (isDebug) console.log("Using sentence after maxLength, result length:", endPosition);
              return text.substring(0, endPosition).trim();
            }
          }

          // If we found a sentence ending before maxLength, use it
          if (lastSentenceEnd > 0) {
            return text.substring(0, lastSentenceEnd).trim();
          }

          // If no sentence ending found, fall back to word boundary
          const truncated = text.substring(0, maxLength);
          const lastSpace = truncated.lastIndexOf(" ");
          if (lastSpace > 0) {
            return text.substring(0, lastSpace).trim() + "...";
          }

          return truncated.trim() + "...";
        }

        // Generate classification icons for a mitzvah
        getClassificationIcons(mitzvah) {
          if (!mitzvah.classification) return "";

          let icons = [];
          const c = mitzvah.classification;

          // Applies To icons
          if (c.applies_to && Array.isArray(c.applies_to) && c.applies_to.length > 0) {
            if (c.applies_to.includes("All Israel") || (c.applies_to.includes("Men") && c.applies_to.includes("Women"))) {
              icons.push('<span class="icon-badge icon-all" title="All Israel">üë•</span>');
            } else if (c.applies_to.includes("Men")) {
              icons.push('<span class="icon-badge icon-men" title="Men">üë®</span>');
            } else if (c.applies_to.includes("Women")) {
              icons.push('<span class="icon-badge icon-women" title="Women">üë©</span>');
            }
            if (c.applies_to.includes("Kohanim")) {
              icons.push('<span class="icon-badge icon-men" title="Kohanim">üïäÔ∏è</span>');
            }
            if (c.applies_to.includes("Levites")) {
              icons.push('<span class="icon-badge icon-men" title="Levites">üìú</span>');
            }
          }

          // Time scope icons
          if (c.time_scope) {
            if (c.time_scope === "Always") {
              icons.push('<span class="icon-badge icon-time-always" title="Always">‚è∞</span>');
            } else if (c.time_scope.includes("Festival") || c.time_scope.includes("Holiday")) {
              icons.push('<span class="icon-badge icon-time-festival" title="Festival/Holiday">üéä</span>');
            } else if (c.time_scope.includes("Temple")) {
              icons.push('<span class="icon-badge icon-time-conditional" title="Temple Era">üèõÔ∏è</span>');
            } else {
              icons.push('<span class="icon-badge icon-time-conditional" title="' + c.time_scope + '">‚è≥</span>');
            }
          }

          // Location icons
          if (c.location) {
            if (c.location.includes("Temple")) {
              icons.push('<span class="icon-badge icon-location-temple" title="Temple">üèõÔ∏è</span>');
            } else if (c.location.includes("Eretz Yisrael") || c.location.includes("Israel")) {
              icons.push('<span class="icon-badge icon-location-israel" title="Eretz Yisrael">üáÆüá±</span>');
            } else if (c.location === "Anywhere") {
              icons.push('<span class="icon-badge icon-location-anywhere" title="Anywhere">üåç</span>');
            }
          }

          return icons.join("");
        }

        async loadData() {
          try {
            // Load English data
            const enResponse = await fetch("mitzvot_data.json");
            if (!enResponse.ok) {
              throw new Error(`Failed to load English data: ${enResponse.status}`);
            }
            this.data = await enResponse.json();

            // Load Hebrew data
            try {
              const heResponse = await fetch("mitzvot_data_he.json");
              if (heResponse.ok) {
                this.heData = await heResponse.json();

                // Create map for Hebrew titles
                const heTitleById = new Map(this.heData.mitzvot.map((m) => [m.id, m.title]));

                // Augment English mitzvot with Hebrew titles when available
                this.data.mitzvot = this.data.mitzvot.map((m) => ({
                  ...m,
                  title_he: heTitleById.get(m.id) || null,
                }));
              } else {
                console.warn("Hebrew data not available");
              }
            } catch (heErr) {
              console.warn("Failed to load Hebrew data, proceeding with English only.", heErr);
            }

            this.filteredData = [...this.data.mitzvot];
          } catch (error) {
            console.error("Error loading data:", error);
            throw error;
          }
        }

        setupEventListeners() {
          // Search
          document.getElementById("searchInput").addEventListener("input", (e) => {
            this.filterData();
          });

          // Book filter
          $("#bookFilter").on("change", (e) => {
            // Reset parasha filter when book changes
            $("#parashaFilter").val("").trigger("change");
            this.renderParashaFilter();
            this.filterData();
          });

          // Parasha filter
          $("#parashaFilter").on("change", (e) => {
            this.filterData();
          });

          // Classification filters
          $("#categoryFilter").on("change", (e) => {
            this.filterData();
          });

          $("#appliesToFilter").on("change", (e) => {
            this.filterData();
          });

          $("#locationFilter").on("change", (e) => {
            this.filterData();
          });

          $("#timeScopeFilter").on("change", (e) => {
            this.filterData();
          });

          // Sort buttons
          document.querySelectorAll(".sort-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const sortField = e.target.dataset.sort;
              this.setSort(sortField);
            });
          });

          // Sortable table headers
          document.querySelectorAll("th.sortable").forEach((th) => {
            th.addEventListener("click", (e) => {
              const sortField = e.currentTarget.dataset.sort;
              this.setSort(sortField);
            });
          });
        }

        setSort(field) {
          if (this.sortField === field) {
            this.sortDirection = this.sortDirection === "asc" ? "desc" : "asc";
          } else {
            this.sortField = field;
            this.sortDirection = "asc";
          }

          // Update active sort button
          document.querySelectorAll(".sort-btn").forEach((btn) => {
            btn.classList.remove("active");
          });
          const activeBtn = document.querySelector(`[data-sort="${field}"]`);
          if (activeBtn && activeBtn.classList.contains("sort-btn")) {
            activeBtn.classList.add("active");
          }

          // Update sortable table header indicators
          document.querySelectorAll("th.sortable").forEach((th) => {
            const indicator = th.querySelector(".sort-indicator");
            if (indicator) {
              if (th.dataset.sort === field) {
                th.classList.add("active");
                indicator.textContent = this.sortDirection === "asc" ? "‚ñ≤" : "‚ñº";
              } else {
                th.classList.remove("active");
                indicator.textContent = "";
              }
            }
          });

          this.sortData();
          this.render();
        }

        sortData() {
          this.filteredData.sort((a, b) => {
            let aVal, bVal;

            // Special handling for book and parasha sorting
            if (this.sortField === "book") {
              aVal = a.book_order || 999;
              bVal = b.book_order || 999;
            } else if (this.sortField === "parasha") {
              aVal = a.global_parasha_order || 999;
              bVal = b.global_parasha_order || 999;
            } else {
              aVal = a[this.sortField];
              bVal = b[this.sortField];

              if (typeof aVal === "string") {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
              }
            }

            if (this.sortDirection === "asc") {
              return aVal > bVal ? 1 : -1;
            } else {
              return aVal < bVal ? 1 : -1;
            }
          });
        }

        setTypeFilter(type) {
          // Toggle behavior: clicking the active type clears it back to All
          this.typeFilter = this.typeFilter === type ? "" : type;
          this.currentPage = 1; // Reset to first page
          this.filterData();
        }

        // Render compact scope icon filters panel
        renderScopeFilters() {
          const el = document.getElementById("scopeFilters");
          if (!el) return;

          // Dispose existing tooltips before re-rendering
          const existingTooltips = el.querySelectorAll('[data-bs-toggle="tooltip"]');
          existingTooltips.forEach((el) => {
            const tooltip = bootstrap.Tooltip.getInstance(el);
            if (tooltip) tooltip.dispose();
          });

          const scopes = [
            { key: "men", label: "Men", icon: "üë®", title: "Applies to Men" },
            { key: "women", label: "Women", icon: "üë©", title: "Applies to Women" },
            { key: "all_israel", label: "All Israel", icon: "üë•", title: "All Israel" },
            { key: "israel", label: "Eretz Yisrael", icon: "üáÆüá±", title: "Eretz Yisrael" },
            { key: "anywhere", label: "Anywhere", icon: "üåç", title: "Anywhere" },
            { key: "always", label: "Always", icon: "‚è∞", title: "Always" },
            { key: "temple", label: "Temple Era", icon: "üèõÔ∏è", title: "Temple Era" },
          ];
          const chips = scopes
            .map((s) => {
              const active = this.activeScopeKey === s.key ? "active" : "";
              const muted = this.activeScopeKey && this.activeScopeKey !== s.key ? "muted" : "";
              return `<button class="scope-chip ${active} ${muted}" data-bs-toggle="tooltip" data-bs-placement="top" title="${s.title}" aria-label="${s.label}" aria-pressed="${
                active ? "true" : "false"
              }" onclick="app.toggleScopeFilter('${s.key}')">${s.icon}</button>`;
            })
            .join("");
          el.innerHTML = `<div class="scope-chip-row">${chips}</div>`;

          // Initialize Bootstrap tooltips
          const tooltipTriggerList = el.querySelectorAll('[data-bs-toggle="tooltip"]');
          [...tooltipTriggerList].map((tooltipTriggerEl) => new bootstrap.Tooltip(tooltipTriggerEl));
        }

        toggleScopeFilter(key) {
          this.activeScopeKey = this.activeScopeKey === key ? "" : key;
          this.currentPage = 1;

          // Sync scope filter with dropdown filters
          if (this.activeScopeKey) {
            switch (key) {
              case "men":
                $("#appliesToFilter").val("Men").trigger("change");
                break;
              case "women":
                $("#appliesToFilter").val("Women").trigger("change");
                break;
              case "all_israel":
                $("#appliesToFilter").val("All Israel").trigger("change");
                break;
              case "israel":
                $("#locationFilter").val("Eretz Yisrael").trigger("change");
                break;
              case "anywhere":
                $("#locationFilter").val("Anywhere").trigger("change");
                break;
              case "always":
                $("#timeScopeFilter").val("Always").trigger("change");
                break;
              case "temple":
                $("#timeScopeFilter").val("Temple Era").trigger("change");
                break;
            }
          } else {
            // Clear all dropdowns when deactivating scope filter
            $("#appliesToFilter").val("").trigger("change");
            $("#locationFilter").val("").trigger("change");
            $("#timeScopeFilter").val("").trigger("change");
          }

          this.filterData();
        }

        matchesScope(mitzvah, key) {
          const c = mitzvah.classification || {};
          const applies = Array.isArray(c.applies_to) ? c.applies_to : [];
          const loc = c.location || "";
          const time = c.time_scope || "";
          switch (key) {
            case "men":
              return applies.includes("Men");
            case "women":
              return applies.includes("Women");
            case "all_israel":
              return applies.includes("All Israel") || (applies.includes("Men") && applies.includes("Women"));
            case "israel":
              return /Eretz Yisrael|Israel/i.test(loc);
            case "anywhere":
              return loc === "Anywhere";
            case "always":
              return time === "Always";
            case "temple":
              return /Temple/i.test(time) || /Temple/i.test(loc);
            default:
              return true;
          }
        }

        filterData() {
          const searchTerm = document.getElementById("searchInput").value.toLowerCase();
          const typeFilter = this.typeFilter; // Use the stat card filter instead
          const bookFilter = document.getElementById("bookFilter").value;
          const parashaFilter = document.getElementById("parashaFilter").value;
          const categoryFilter = document.getElementById("categoryFilter").value;
          const appliesToFilter = document.getElementById("appliesToFilter").value;
          const locationFilter = document.getElementById("locationFilter").value;
          const timeScopeFilter = document.getElementById("timeScopeFilter").value;

          this.filteredData = this.data.mitzvot.filter((mitzvah) => {
            const matchesSearch =
              !searchTerm ||
              mitzvah.title.toLowerCase().includes(searchTerm) ||
              (mitzvah.title_he && mitzvah.title_he.toLowerCase().includes(searchTerm)) ||
              mitzvah.description.toLowerCase().includes(searchTerm) ||
              (mitzvah.classification && mitzvah.classification.main_category && mitzvah.classification.main_category.toLowerCase().includes(searchTerm)) ||
              (mitzvah.classification && mitzvah.classification.sub_category && mitzvah.classification.sub_category.toLowerCase().includes(searchTerm)) ||
              (mitzvah.classification && mitzvah.classification.main_location && mitzvah.classification.main_location.toLowerCase().includes(searchTerm)) ||
              (mitzvah.classification && mitzvah.classification.location && mitzvah.classification.location.toLowerCase().includes(searchTerm)) ||
              (mitzvah.classification && mitzvah.classification.main_time_scope && mitzvah.classification.main_time_scope.toLowerCase().includes(searchTerm)) ||
              (mitzvah.classification && mitzvah.classification.time_scope && mitzvah.classification.time_scope.toLowerCase().includes(searchTerm)) ||
              (mitzvah.classification &&
                mitzvah.classification.main_applies_to &&
                Array.isArray(mitzvah.classification.main_applies_to) &&
                mitzvah.classification.main_applies_to.some((a) => a.toLowerCase().includes(searchTerm))) ||
              (mitzvah.classification &&
                mitzvah.classification.applies_to &&
                Array.isArray(mitzvah.classification.applies_to) &&
                mitzvah.classification.applies_to.some((a) => a.toLowerCase().includes(searchTerm)));

            const matchesType = !typeFilter || mitzvah.type === typeFilter;
            const matchesScope = !this.activeScopeKey || this.matchesScope(mitzvah, this.activeScopeKey);
            const matchesBook = !bookFilter || mitzvah.book_en === bookFilter;
            const matchesParasha = !parashaFilter || mitzvah.parasha === parashaFilter;

            // Classification filters
            const matchesCategory = !categoryFilter || (mitzvah.classification && mitzvah.classification.main_category === categoryFilter);
            const matchesAppliesTo =
              !appliesToFilter ||
              (mitzvah.classification &&
                mitzvah.classification.main_applies_to &&
                Array.isArray(mitzvah.classification.main_applies_to) &&
                mitzvah.classification.main_applies_to.includes(appliesToFilter));
            const matchesLocation = !locationFilter || (mitzvah.classification && mitzvah.classification.main_location === locationFilter);
            const matchesTimeScope = !timeScopeFilter || (mitzvah.classification && mitzvah.classification.main_time_scope === timeScopeFilter);

            return matchesSearch && matchesType && matchesScope && matchesBook && matchesParasha && matchesCategory && matchesAppliesTo && matchesLocation && matchesTimeScope;
          });

          this.sortData();
          this.currentPage = 1;
          this.render();
        }

        render() {
          this.renderStats();
          this.renderHeaderStats();
          this.renderBookFilter();
          this.renderScopeFilters();
          this.renderParashaFilter();
          this.renderClassificationFilters();
          this.renderTable();
          this.renderPagination();
        }

        renderHeaderStats() {
          const container = document.getElementById("headerStats");
          if (!container) return;

          const totalCount = this.filteredData.length;
          const positiveCount = this.filteredData.filter((m) => m.type === "Positive").length;
          const negativeCount = this.filteredData.filter((m) => m.type === "Negative").length;

          container.innerHTML = `
            <div class="stat-card stat-total">
              <div class="stat-content">
                <span class="stat-number">${totalCount}</span>
                <span class="stat-label">Total</span>
              </div>
              <i data-lucide="hash" class="stat-icon"></i>
            </div>
            <div class="stat-card stat-positive">
              <div class="stat-content">
                <span class="stat-number">${positiveCount}</span>
                <span class="stat-label">Positive</span>
              </div>
              <i data-lucide="circle-plus" class="stat-icon"></i>
            </div>
            <div class="stat-card stat-negative">
              <div class="stat-content">
                <span class="stat-number">${negativeCount}</span>
                <span class="stat-label">Negative</span>
              </div>
              <i data-lucide="circle-minus" class="stat-icon"></i>
            </div>
          `;

          if (typeof lucide !== "undefined") {
            lucide.createIcons();
          }
        }

        renderStats() {
          const statsContainer = document.getElementById("stats");

          // Dispose existing tooltips before re-rendering
          const existingTooltips = statsContainer.querySelectorAll('[data-bs-toggle="tooltip"]');
          existingTooltips.forEach((el) => {
            const tooltip = bootstrap.Tooltip.getInstance(el);
            if (tooltip) tooltip.dispose();
          });

          // Global counts (tooltips only)
          const positiveCount = this.data ? this.data.mitzvot.filter((m) => m.type === "Positive").length : 0;
          const negativeCount = this.data ? this.data.mitzvot.filter((m) => m.type === "Negative").length : 0;

          const anyTypeActive = this.typeFilter !== "";
          const positiveActive = this.typeFilter === "Positive" ? "active" : "";
          const negativeActive = this.typeFilter === "Negative" ? "active" : "";
          const positiveMuted = anyTypeActive && this.typeFilter !== "Positive" ? "muted" : "";
          const negativeMuted = anyTypeActive && this.typeFilter !== "Negative" ? "muted" : "";

          statsContainer.innerHTML = `
            <div class="scope-chip-row">
              <button class="scope-chip positive ${positiveActive} ${positiveMuted}" data-bs-toggle="tooltip" data-bs-placement="top" title="Positive ‚Äî ${positiveCount}" aria-label="Positive" aria-pressed="${
            this.typeFilter === "Positive"
          }" onclick="app.setTypeFilter('Positive')">
                <i data-lucide="circle-plus" class="chip-icon"></i>
              </button>
              <button class="scope-chip negative ${negativeActive} ${negativeMuted}" data-bs-toggle="tooltip" data-bs-placement="top" title="Negative ‚Äî ${negativeCount}" aria-label="Negative" aria-pressed="${
            this.typeFilter === "Negative"
          }" onclick="app.setTypeFilter('Negative')">
                <i data-lucide="circle-minus" class="chip-icon"></i>
              </button>
            </div>
          `;

          if (typeof lucide !== "undefined") {
            lucide.createIcons();
          }

          // Initialize Bootstrap tooltips
          const tooltipTriggerList = statsContainer.querySelectorAll('[data-bs-toggle="tooltip"]');
          [...tooltipTriggerList].map((tooltipTriggerEl) => new bootstrap.Tooltip(tooltipTriggerEl));
        }

        renderParashaFilter() {
          const parashaFilter = document.getElementById("parashaFilter");
          const bookFilter = document.getElementById("bookFilter").value;

          // Get unique parashot with their global order
          const parashotMap = new Map();
          this.data.mitzvot.forEach((m) => {
            if (m.parasha && (!bookFilter || m.book_en === bookFilter)) {
              if (!parashotMap.has(m.parasha)) {
                parashotMap.set(m.parasha, m.global_parasha_order || 999);
              }
            }
          });

          // Sort by global order
          const parashot = Array.from(parashotMap.entries())
            .sort((a, b) => a[1] - b[1])
            .map(([parasha]) => parasha);

          // Update select options
          const currentValue = parashaFilter.value;
          const html = '<option value="">All Parashot</option>' + parashot.map((parasha) => `<option value="${parasha}">${parasha}</option>`).join("");
          parashaFilter.innerHTML = html;

          // Restore previous selection if still valid
          if (currentValue && parashot.includes(currentValue)) {
            parashaFilter.value = currentValue;
          }

          // Trigger Select2 update
          if ($(parashaFilter).data("select2")) {
            $(parashaFilter).trigger("change.select2");
          }
        }

        renderBookFilter() {
          const bookFilter = document.getElementById("bookFilter");

          // Get unique books with their order
          const booksMap = new Map();
          this.data.mitzvot.forEach((m) => {
            if (m.book_en) {
              if (!booksMap.has(m.book_en)) {
                booksMap.set(m.book_en, m.book_order || 999);
              }
            }
          });

          // Sort by book order
          const books = Array.from(booksMap.entries())
            .sort((a, b) => a[1] - b[1])
            .map(([book]) => book);

          // Update select options
          const $bookFilter = $("#bookFilter");
          const currentValue = $bookFilter.val();
          const html = '<option value="">All Books</option>' + books.map((book) => `<option value="${book}">${book}</option>`).join("");

          $bookFilter.html(html);

          // Restore previous selection if still valid
          if (currentValue && books.includes(currentValue)) {
            $bookFilter.val(currentValue);
          }

          // Trigger Select2 update
          $bookFilter.trigger("change.select2");
        }

        renderClassificationFilters() {
          // Get unique values from classifications
          const categories = [...new Set(this.data.mitzvot.filter((m) => m.classification && m.classification.main_category).map((m) => m.classification.main_category))].sort();

          const locations = [...new Set(this.data.mitzvot.filter((m) => m.classification && m.classification.main_location).map((m) => m.classification.main_location))].sort();

          const timeScopes = [...new Set(this.data.mitzvot.filter((m) => m.classification && m.classification.main_time_scope).map((m) => m.classification.main_time_scope))].sort();

          // Get all unique "main_applies_to" values (flatten arrays) - using main groups instead of specific values
          const appliesTo = [
            ...new Set(
              this.data.mitzvot.filter((m) => m.classification && m.classification.main_applies_to && Array.isArray(m.classification.main_applies_to)).flatMap((m) => m.classification.main_applies_to)
            ),
          ].sort();

          // Update category filter
          const $categoryFilter = $("#categoryFilter");
          const categoryValue = $categoryFilter.val(); // Save current value
          $categoryFilter.html('<option value="">All Categories</option>' + categories.map((cat) => `<option value="${cat}">${cat}</option>`).join(""));
          if (categoryValue && categories.includes(categoryValue)) {
            $categoryFilter.val(categoryValue); // Restore value if still valid
          }
          $categoryFilter.trigger("change.select2");

          // Update applies to filter
          const $appliesToFilter = $("#appliesToFilter");
          const appliesToValue = $appliesToFilter.val(); // Save current value
          $appliesToFilter.html('<option value="">Applies To: All</option>' + appliesTo.map((person) => `<option value="${person}">${person}</option>`).join(""));
          if (appliesToValue && appliesTo.includes(appliesToValue)) {
            $appliesToFilter.val(appliesToValue); // Restore value if still valid
          }
          $appliesToFilter.trigger("change.select2");

          // Update location filter
          const $locationFilter = $("#locationFilter");
          const locationValue = $locationFilter.val(); // Save current value
          $locationFilter.html('<option value="">All Locations</option>' + locations.map((loc) => `<option value="${loc}">${loc}</option>`).join(""));
          if (locationValue && locations.includes(locationValue)) {
            $locationFilter.val(locationValue); // Restore value if still valid
          }
          $locationFilter.trigger("change.select2");

          // Update time scope filter
          const $timeScopeFilter = $("#timeScopeFilter");
          const timeScopeValue = $timeScopeFilter.val(); // Save current value
          $timeScopeFilter.html('<option value="">All Time Scopes</option>' + timeScopes.map((ts) => `<option value="${ts}">${ts}</option>`).join(""));
          if (timeScopeValue && timeScopes.includes(timeScopeValue)) {
            $timeScopeFilter.val(timeScopeValue); // Restore value if still valid
          }
          $timeScopeFilter.trigger("change.select2");
        }

        renderTable() {
          const tableBody = document.getElementById("mitzvotTableBody");
          const startIndex = (this.currentPage - 1) * this.itemsPerPage;
          const endIndex = startIndex + this.itemsPerPage;
          const pageData = this.filteredData.slice(startIndex, endIndex);

          tableBody.innerHTML = pageData
            .map((mitzvah) => {
              // Find corresponding Hebrew data
              const mitzvahHe = this.heData ? this.heData.mitzvot.find((m) => m.id === mitzvah.id) : null;

              // Build title based on selected language
              const heTitle = mitzvah.title_he || (mitzvahHe ? mitzvahHe.title : null);
              let titleHtml = "";
              if (this.tableLanguage === "en") {
                titleHtml = `<div class="title-en">${mitzvah.title}</div>`;
              } else if (this.tableLanguage === "he") {
                if (heTitle) {
                  titleHtml = `<div class="title-he" lang="he" dir="rtl">${heTitle}</div>`;
                } else {
                  // Fallback to English if no Hebrew title
                  titleHtml = `<div class="title-en">${mitzvah.title}</div>`;
                }
              } else {
                // both
                titleHtml = `<div class="title-en">${mitzvah.title}</div>`;
                if (heTitle) {
                  titleHtml += `<div class="title-he" lang="he" dir="rtl">${heTitle}</div>`;
                }
              }

              // Build description based on selected language
              let descriptionHtml = "";
              if (this.tableLanguage === "en") {
                descriptionHtml = this.truncateText(mitzvah.description, 150);
              } else if (this.tableLanguage === "he" && mitzvahHe && mitzvahHe.description) {
                descriptionHtml = `<span class="text-he" lang="he" dir="rtl">${this.truncateText(mitzvahHe.description, 150)}</span>`;
              } else if (this.tableLanguage === "both") {
                descriptionHtml = `<div>${this.truncateText(mitzvah.description, 150)}</div>`;
                if (mitzvahHe && mitzvahHe.description) {
                  descriptionHtml += `<div class="text-he" lang="he" dir="rtl" style="margin-top: 8px; font-size: 0.95em;">${this.truncateText(mitzvahHe.description, 150)}</div>`;
                }
              }

              // Build parasha based on selected language
              const heParasha = mitzvahHe && (mitzvahHe.parasha_he || mitzvahHe.parasha) ? mitzvahHe.parasha_he || mitzvahHe.parasha : null;
              let parashaHtml = "";
              if (this.tableLanguage === "en") {
                parashaHtml = `<div class="parasha-en">${mitzvah.parasha || ""}</div>`;
              } else if (this.tableLanguage === "he") {
                if (heParasha) {
                  parashaHtml = `<div class="parasha-he text-he" lang="he" dir="rtl">${heParasha}</div>`;
                } else {
                  parashaHtml = `<div class="parasha-en">${mitzvah.parasha || ""}</div>`;
                }
              } else {
                // both
                parashaHtml = `<div class="parasha-en">${mitzvah.parasha || ""}</div>`;
                if (heParasha) {
                  parashaHtml += `<div class="parasha-he text-he" lang="he" dir="rtl">${heParasha}</div>`;
                }
              }

              return `
          <tr>
            <td class="mitzvah-number">${mitzvah.id}</td>
            <td><span class="mitzvah-type ${mitzvah.type.toLowerCase()}">${mitzvah.type}</span></td>
            <td class="mitzvah-title">${titleHtml}</td>
            <td class="classification-icons">${this.getClassificationIcons(mitzvah)}</td>
            <td class="description">${descriptionHtml}</td>
            <td class="parasha">${parashaHtml}</td>
            <td>
              <div class="details-actions">
                <button class="details-toggle" onclick="app.openSidebar(${mitzvah.id})" title="Show full details">
                  üìã
                </button>
                ${
                  this.cardsEnabled
                    ? `<button class="card-toggle" onclick="app.openCardModal(${mitzvah.id})" title="View as card">
                  üÉè
                </button>`
                    : ""
                }
              </div>
            </td>
          </tr>
        `;
            })
            .join("");

          // Render mobile cards
          const mobileCardsHTML = pageData
            .map((mitzvah) => {
              const mitzvahHe = this.heData?.mitzvot?.find((m) => m.id === mitzvah.id);
              const heTitle = mitzvah.title_he || (mitzvahHe ? mitzvahHe.title : null);

              let titleHtml = "";
              if (this.tableLanguage === "en") {
                titleHtml = mitzvah.title;
              } else if (this.tableLanguage === "he" && heTitle) {
                titleHtml = `<span lang="he" dir="rtl">${heTitle}</span>`;
              } else if (this.tableLanguage === "both") {
                titleHtml = mitzvah.title;
                if (heTitle) {
                  titleHtml += `<br><span class="text-he" lang="he" dir="rtl">${heTitle}</span>`;
                }
              }

              const heParasha = mitzvahHe && (mitzvahHe.parasha_he || mitzvahHe.parasha) ? mitzvahHe.parasha_he || mitzvahHe.parasha : null;
              let parashaHtml = "";
              if (this.tableLanguage === "he" && heParasha) {
                parashaHtml = `<span lang="he" dir="rtl">${heParasha}</span>`;
              } else {
                parashaHtml = mitzvah.parasha || "";
              }

              // Build description based on selected language
              let descriptionHtml = "";
              if (this.tableLanguage === "en") {
                descriptionHtml = this.truncateText(mitzvah.description, 120);
              } else if (this.tableLanguage === "he" && mitzvahHe && mitzvahHe.description) {
                descriptionHtml = `<span class="text-he" lang="he" dir="rtl">${this.truncateText(mitzvahHe.description, 120)}</span>`;
              } else if (this.tableLanguage === "both") {
                descriptionHtml = this.truncateText(mitzvah.description, 120);
                if (mitzvahHe && mitzvahHe.description) {
                  descriptionHtml += `<br><span class="text-he" lang="he" dir="rtl" style="display: block; margin-top: 8px;">${this.truncateText(mitzvahHe.description, 120)}</span>`;
                }
              }

              return `
                <div class="mitzvah-card">
                  <div class="card-header">
                    <div class="card-header-left">
                      <span class="card-number">#${mitzvah.id}</span>
                      <span class="mitzvah-type ${mitzvah.type.toLowerCase()}">${mitzvah.type}</span>
                    </div>
                    <button class="details-toggle" onclick="app.openSidebar(${mitzvah.id})" title="Show full details">
                      üìã
                    </button>
                  </div>
                  <div class="card-title">${titleHtml}</div>
                  <div class="card-description">${descriptionHtml}</div>
                  <div class="card-meta">
                    <div class="card-parasha">
                      <span class="parasha-label">Parasha:</span> ${parashaHtml}
                    </div>
                    <div class="card-scope">${this.getClassificationIcons(mitzvah)}</div>
                  </div>
                </div>
              `;
            })
            .join("");

          document.getElementById("mobileCards").innerHTML = mobileCardsHTML;

          // Show table container and language toggle
          document.getElementById("tableContainer").style.display = "block";
          document.getElementById("tableLanguageToggle").style.display = "block";
          document.getElementById("loading").style.display = "none";
        }

        renderPagination() {
          const pagination = document.getElementById("pagination");
          const totalPages = Math.ceil(this.filteredData.length / this.itemsPerPage);

          if (totalPages <= 1) {
            pagination.style.display = "none";
            return;
          }

          pagination.style.display = "block";

          let paginationHTML = "";

          // Previous button
          paginationHTML += `<button ${this.currentPage === 1 ? "disabled" : ""} onclick="app.goToPage(${this.currentPage - 1})">Previous</button>`;

          // Page numbers
          const startPage = Math.max(1, this.currentPage - 2);
          const endPage = Math.min(totalPages, this.currentPage + 2);

          if (startPage > 1) {
            paginationHTML += `<button onclick="app.goToPage(1)">1</button>`;
            if (startPage > 2) {
              paginationHTML += `<span>...</span>`;
            }
          }

          for (let i = startPage; i <= endPage; i++) {
            const isCurrent = i === this.currentPage;
            paginationHTML += `<button class="${isCurrent ? "current" : ""}" onclick="app.goToPage(${i})">${i}</button>`;
          }

          if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
              paginationHTML += `<span>...</span>`;
            }
            paginationHTML += `<button onclick="app.goToPage(${totalPages})">${totalPages}</button>`;
          }

          // Next button
          paginationHTML += `<button ${this.currentPage === totalPages ? "disabled" : ""} onclick="app.goToPage(${this.currentPage + 1})">Next</button>`;

          pagination.innerHTML = paginationHTML;
        }

        goToPage(page) {
          const totalPages = Math.ceil(this.filteredData.length / this.itemsPerPage);
          if (page >= 1 && page <= totalPages) {
            this.currentPage = page;
            this.renderTable();
            this.renderPagination();
          }
        }

        openSidebar(id) {
          this.currentMitzvahId = id;
          this.renderSidebarContent();

          // Show sidebar
          document.getElementById("sidebarOverlay").classList.add("show");
          document.getElementById("sidebar").classList.add("show");
        }

        setLanguage(lang) {
          this.currentLanguage = lang;

          // Update active button
          document.querySelectorAll(".language-btn").forEach((btn) => {
            btn.classList.remove("active");
            if (btn.dataset.lang === lang) {
              btn.classList.add("active");
            }
          });

          // Re-render content if sidebar is open
          if (this.currentMitzvahId) {
            this.renderSidebarContent();
          }
        }

        setTableLanguage(lang) {
          this.tableLanguage = lang;

          // Update active button
          document.querySelectorAll(".table-lang-btn").forEach((btn) => {
            btn.classList.remove("active");
            if (btn.dataset.lang === lang) {
              btn.classList.add("active");
            }
          });

          // Re-render table with new language
          this.renderTable();
        }

        toggleMoreFilters() {
          this.moreFiltersVisible = !this.moreFiltersVisible;
          const secondaryFilters = document.getElementById("secondaryFilters");
          const moreFiltersText = document.getElementById("moreFiltersText");
          const moreFiltersIcon = document.getElementById("moreFiltersIcon");

          if (this.moreFiltersVisible) {
            secondaryFilters.style.display = "flex";
            moreFiltersText.textContent = "Less Filters";
            moreFiltersIcon.textContent = "‚ñ≤";
          } else {
            secondaryFilters.style.display = "none";
            moreFiltersText.textContent = "More Filters";
            moreFiltersIcon.textContent = "‚ñº";
          }
        }

        renderSidebarContent() {
          const mitzvah = this.data.mitzvot.find((m) => m.id === this.currentMitzvahId);
          if (!mitzvah) return;

          // Find corresponding Hebrew data
          const mitzvahHe = this.heData ? this.heData.mitzvot.find((m) => m.id === this.currentMitzvahId) : null;

          // Set title based on language
          const sidebarTitle = document.getElementById("sidebarTitle");
          if (this.currentLanguage === "en") {
            sidebarTitle.textContent = mitzvah.title;
          } else if (this.currentLanguage === "he" && mitzvahHe) {
            sidebarTitle.innerHTML = `<span class="text-he">${mitzvahHe.title}</span>`;
          } else if (this.currentLanguage === "both") {
            sidebarTitle.innerHTML = `${mitzvah.title}<br><span class="text-he">${mitzvahHe ? mitzvahHe.title : ""}</span>`;
          }

          // Build content
          const sidebarContent = document.getElementById("sidebarContent");
          let html = '<div class="sidebar-meta">';

          // Mitzvah number badge with type color
          const typeClass = mitzvah.type.toLowerCase();
          html += `<div><strong>Mitzvah:</strong> <span class="mitzvah-number-badge ${typeClass}">#${mitzvah.id}</span></div>`;

          // Type with badge
          html += `<div><strong>Type:</strong> <span class="mitzvah-type ${typeClass}">${mitzvah.type}</span></div>`;

          // Parasha - show in appropriate language
          let parashaDisplay = "";
          if (this.currentLanguage === "en") {
            parashaDisplay = mitzvah.parasha;
          } else if (this.currentLanguage === "he" && mitzvahHe) {
            parashaDisplay = `<span class="text-he">${mitzvahHe.parasha}</span>`;
          } else if (this.currentLanguage === "both") {
            parashaDisplay = `${mitzvah.parasha} / <span class="text-he">${mitzvahHe ? mitzvahHe.parasha : mitzvah.parasha}</span>`;
          }
          html += `<div><strong>Parasha:</strong> ${parashaDisplay}</div>`;
          html += "</div>";

          // Description
          if (this.currentLanguage === "en" && mitzvah.description) {
            html += `<div class="sidebar-section"><h3>Description</h3><p>${mitzvah.description}</p></div>`;
          } else if (this.currentLanguage === "he" && mitzvahHe && mitzvahHe.description) {
            html += `<div class="sidebar-section"><h3 class="text-he">◊™◊ô◊ê◊ï◊®</h3><p class="text-he">${mitzvahHe.description}</p></div>`;
          } else if (this.currentLanguage === "both") {
            html += '<div class="sidebar-section"><h3>Description / ◊™◊ô◊ê◊ï◊®</h3>';
            if (mitzvah.description) {
              html += `<div class="interlinear-container"><div class="interlinear-en">${mitzvah.description}</div>`;
              if (mitzvahHe && mitzvahHe.description) {
                html += `<div class="interlinear-he">${mitzvahHe.description}</div>`;
              }
              html += "</div>";
            }
            html += "</div>";
          }

          // Full text
          if (this.currentLanguage === "en" && mitzvah.full_text) {
            html += `<div class="sidebar-section"><h3>Full Text</h3><p>${mitzvah.full_text}</p></div>`;
          } else if (this.currentLanguage === "he" && mitzvahHe && mitzvahHe.full_text) {
            html += `<div class="sidebar-section"><h3 class="text-he">◊ò◊ß◊°◊ò ◊û◊ú◊ê</h3><p class="text-he">${mitzvahHe.full_text}</p></div>`;
          } else if (this.currentLanguage === "both") {
            html += '<div class="sidebar-section"><h3>Full Text / ◊ò◊ß◊°◊ò ◊û◊ú◊ê</h3>';
            if (mitzvah.full_text) {
              html += `<div class="interlinear-container"><div class="interlinear-en">${mitzvah.full_text}</div>`;
              if (mitzvahHe && mitzvahHe.full_text) {
                html += `<div class="interlinear-he">${mitzvahHe.full_text}</div>`;
              }
              html += "</div>";
            }
            html += "</div>";
          }

          // Details
          if (this.currentLanguage === "en" && mitzvah.details && Array.isArray(mitzvah.details)) {
            html += '<div class="sidebar-section"><h3>Details</h3>';
            mitzvah.details.forEach((detail) => {
              html += `<p>${detail}</p>`;
            });
            html += "</div>";
          } else if (this.currentLanguage === "he" && mitzvahHe && mitzvahHe.details && Array.isArray(mitzvahHe.details)) {
            html += '<div class="sidebar-section"><h3 class="text-he">◊§◊®◊ò◊ô◊ù</h3>';
            mitzvahHe.details.forEach((detail) => {
              html += `<p class="text-he">${detail}</p>`;
            });
            html += "</div>";
          } else if (this.currentLanguage === "both") {
            html += '<div class="sidebar-section"><h3>Details / ◊§◊®◊ò◊ô◊ù</h3>';
            const maxLength = Math.max(mitzvah.details ? mitzvah.details.length : 0, mitzvahHe && mitzvahHe.details ? mitzvahHe.details.length : 0);
            for (let i = 0; i < maxLength; i++) {
              html += '<div class="interlinear-container">';
              if (mitzvah.details && mitzvah.details[i]) {
                html += `<div class="interlinear-en">${mitzvah.details[i]}</div>`;
              }
              if (mitzvahHe && mitzvahHe.details && mitzvahHe.details[i]) {
                html += `<div class="interlinear-he">${mitzvahHe.details[i]}</div>`;
              }
              html += "</div>";
            }
            html += "</div>";
          }

          // Classification (English only for now)
          if (mitzvah.classification) {
            const c = mitzvah.classification;
            html += '<div class="sidebar-section sidebar-classification"><h3>Classification</h3>';

            if (c.category) {
              html += `<div><strong>Category:</strong> ${c.category}</div>`;
            }
            if (c.sub_category) {
              html += `<div><strong>Sub-Category:</strong> ${c.sub_category}</div>`;
            }
            if (c.applies_to && Array.isArray(c.applies_to)) {
              html += `<div><strong>Applies To:</strong> ${c.applies_to.join(", ")}</div>`;
            }
            if (c.location) {
              html += `<div><strong>Location:</strong> ${c.location}</div>`;
            }
            if (c.time_scope) {
              html += `<div><strong>Time Scope:</strong> ${c.time_scope}</div>`;
            }
            if (c.source_refs && Array.isArray(c.source_refs)) {
              html += `<div><strong>Sources:</strong> ${c.source_refs.join(", ")}</div>`;
            }

            html += "</div>";
          }

          sidebarContent.innerHTML = html;
        }

        closeSidebar() {
          document.getElementById("sidebarOverlay").classList.remove("show");
          document.getElementById("sidebar").classList.remove("show");
        }

        openCardModal(id) {
          // Guard: Card feature disabled
          if (!this.cardsEnabled) return;
          this.currentMitzvahId = id;
          this.renderCardContent();

          // Show modal
          document.getElementById("cardModalOverlay").classList.add("show");
          document.getElementById("cardModal").classList.add("show");
        }

        closeCardModal() {
          document.getElementById("cardModalOverlay").classList.remove("show");
          document.getElementById("cardModal").classList.remove("show");
        }

        renderCardContent() {
          const mitzvah = this.data.mitzvot.find((m) => m.id === this.currentMitzvahId);
          if (!mitzvah) return;

          const mitzvahHe = this.heData ? this.heData.mitzvot.find((m) => m.id === this.currentMitzvahId) : null;

          const cardContainer = document.getElementById("mtgCard");

          // Determine card frame color based on type
          const frameClass = mitzvah.type === "Positive" ? "positive-frame" : "negative-frame";

          // Get classification info
          const c = mitzvah.classification || {};

          let html = `<div class="mtg-card-inner ${frameClass}">`;

          // Card Header
          html += '<div class="mtg-card-header">';
          html += `<div class="mtg-card-title">${mitzvah.title}</div>`;
          if (mitzvahHe && mitzvahHe.title) {
            html += `<div class="mtg-card-title-he">${mitzvahHe.title}</div>`;
          }
          html += "</div>";

          // Card Type Line
          html += '<div class="mtg-card-type-line">';
          html += `<span class="mtg-type">${mitzvah.type} Commandment</span>`;
          if (c.category) {
            html += ` ‚Äî <span class="mtg-subtype">${c.category}</span>`;
          }
          html += "</div>";

          // Card Image with extension fallbacks: .png -> .jpg -> .jpeg -> placeholder
          html += '<div class="mtg-card-image">';
          const imagePath = `images/${mitzvah.id}.png`;
          // data-ext-index=0 means current ext is png (index 0 of IMAGE_EXT_FALLBACKS)
          html += `<img src="${imagePath}" alt="${mitzvah.title}" class="mtg-card-image-actual" data-ext-index="0" onerror="loadMitzvahImageFallback(this, '${mitzvah.id}')" />`;
          html += '<div class="mtg-card-image-placeholder" style="display: none;">';
          html += "<span>üñºÔ∏è</span>";
          html += '<span class="placeholder-text">Image Coming Soon</span>';
          html += "</div>";
          html += "</div>";

          // Classification Bar - Category and Icons between image and text box
          html += '<div class="mtg-card-icons-bar">';

          // Category - Sub-category on the left
          if (c.category || c.sub_category) {
            html += '<div class="mtg-card-category">';
            if (c.category) {
              html += c.category;
            }
            if (c.category && c.sub_category) {
              html += " ‚Äî ";
            }
            if (c.sub_category) {
              html += `<span class="mtg-card-subcategory">${c.sub_category}</span>`;
            }
            html += "</div>";
          }

          // Icons on the right
          const icons = this.getClassificationIcons(mitzvah);
          if (icons) {
            html += `<div class="mtg-card-icons">${icons}</div>`;
          }

          html += "</div>";

          // Card Text Box
          html += '<div class="mtg-card-text-box">';

          // Description
          if (mitzvah.description) {
            const descText = this.stripHtmlTags(mitzvah.description);
            html += `<div class="mtg-card-description">${descText}</div>`;
          }

          // Source reference
          if (mitzvah.parasha) {
            html += `<div class="mtg-card-flavor"><em>Parashat ${mitzvah.parasha}</em></div>`;
          }

          html += "</div>";

          // Card Footer (Edition info)
          html += '<div class="mtg-card-footer">';
          html += `<span class="mtg-card-set-info">${mitzvah.book_en || "Torah"}</span>`;
          html += `<span class="mtg-card-number">${mitzvah.id}/613</span>`;
          html += "</div>";

          html += "</div>";

          cardContainer.innerHTML = html;
        }

        stripHtmlTags(html) {
          const temp = document.createElement("div");
          temp.innerHTML = html;
          return temp.textContent || temp.innerText || "";
        }

        showError() {
          document.getElementById("loading").style.display = "none";
          document.getElementById("error").style.display = "block";
        }
      }

      // Function to load and display the Hebrew date
      async function loadHebrewDate(appInstance = null) {
        try {
          const today = new Date();
          const year = today.getFullYear();
          const month = today.getMonth() + 1;
          const day = today.getDate();

          // Format the English date
          const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
          const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
          const dayName = dayNames[today.getDay()];
          const monthName = monthNames[today.getMonth()];
          const englishDate = `${dayName}. ${monthName}. ${day}, ${year}`;

          const url = `https://www.hebcal.com/converter?cfg=json&gy=${year}&gm=${month}&gd=${day}&g2h=1`;
          const response = await fetch(url);
          const data = await response.json();

          // Display the combined date with Hebrew date in English
          const hebrewDateElement = document.getElementById("hebrewDate");
          if (hebrewDateElement && data.hm && data.hd && data.hy) {
            const hebrewDateEng = `${data.hm} ${data.hd}, ${data.hy}`;

            // Build parts array
            let parts = [];

            // Date part
            parts.push(
              `<span class="date-part"><i data-lucide="calendar" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle;"></i> ${englishDate} | ${hebrewDateEng}</span>`
            );

            // Add events if available
            if (data.events && data.events.length > 0) {
              // Extract parashat from events
              const parashat = data.events.find((e) => e.startsWith("Parashat "));
              const otherEvents = data.events.filter((e) => !e.startsWith("Parashat "));

              if (parashat) {
                const parashaName = parashat.replace("Parashat ", "");
                let parashaText = `<i data-lucide="scroll-text" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle;"></i> ${parashaName}`;

                // Count mitzvot for this parasha if data is available
                if (appInstance && appInstance.data && appInstance.data.mitzvot) {
                  const parashotInName = parashaName.split("-").map((p) => p.trim());
                  const mitzvotInParasha = appInstance.data.mitzvot.filter((m) => parashotInName.some((p) => m.parasha && m.parasha.includes(p)));

                  const positiveMitzvot = mitzvotInParasha.filter((m) => m.type === "Positive").length;
                  const negativeMitzvot = mitzvotInParasha.filter((m) => m.type === "Negative").length;

                  if (mitzvotInParasha.length > 0) {
                    parashaText += ` (${positiveMitzvot} pos, ${negativeMitzvot} neg)`;
                  } else {
                    parashaText += ` (No mitzvot)`;
                  }
                }

                parts.push(`<span class="parasha-part">${parashaText}</span>`);
              }

              if (otherEvents.length > 0) {
                parts.push(
                  `<span class="events-part"><i data-lucide="sparkles" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle;"></i> ${otherEvents.join(", ")}</span>`
                );
              }
            }

            hebrewDateElement.innerHTML = parts.join(' <span class="separator">‚Ä¢</span> ');

            // Re-initialize Lucide icons for the newly added elements
            if (typeof lucide !== "undefined") {
              lucide.createIcons();
            }
          }
        } catch (error) {
          console.error("Failed to load Hebrew date:", error);
          const hebrewDateElement = document.getElementById("hebrewDate");
          if (hebrewDateElement) {
            hebrewDateElement.innerHTML = "";
          }
        }
      }

      // Initialize the app when the page loads
      let app;
      document.addEventListener("DOMContentLoaded", () => {
        app = new MitzvotApp();

        // Load Hebrew date
        loadHebrewDate();

        // Show beta notice on first visit
        if (!localStorage.getItem("betaNoticeSeen")) {
          Swal.fire({
            icon: "info",
            title: "Welcome to 613 Mitzvot",
            html: `
              <div style="font-size: 13px; color: #6c757d; line-height: 1.5;">
                <p style="margin-bottom: 10px;">This project is a work in progress and may contain errors or inaccuracies. If you're citing information, please verify with official sources.</p>
                <p style="margin-bottom: 0;">Your feedback and corrections are warmly welcomed! Feel free to reach out at <a href="mailto:moxaku@gmail.com" style="color: #0d6efd; text-decoration: none;">moxaku@gmail.com</a></p>
              </div>
            `,
            confirmButtonText: "Get Started",
            confirmButtonColor: "#6c757d",
            allowOutsideClick: true,
            width: "420px",
            padding: "1.25rem",
            backdrop: "rgba(0,0,0,0.3)",
            customClass: {
              popup: "subtle-popup",
              title: "subtle-title",
              confirmButton: "subtle-button",
              icon: "subtle-icon",
            },
          }).then(() => {
            localStorage.setItem("betaNoticeSeen", "true");
          });
        }
      });
    </script>
  </body>
</html>
